<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Système de Chargement - Notre Hybride vs ChatGPT</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      .test-section {
        border: 2px solid #ddd;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .success {
        border-color: #4caf50;
        background-color: #f1f8e9;
      }
      .error {
        border-color: #f44336;
        background-color: #ffebee;
      }
      .warning {
        border-color: #ff9800;
        background-color: #fff3e0;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        margin: 10px 0;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-test {
        background: #2196f3;
        color: white;
      }
      .btn-clear {
        background: #757575;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>
      🧪 Test de Performance : Notre Système Hybride vs Suggestions ChatGPT
    </h1>

    <!-- SECTION 1: Notre système actuel -->
    <div class="test-section">
      <h2>🚀 Notre Système Hybride Intelligent</h2>
      <p>
        <strong>Architecture:</strong> Script src → fetch/eval → CDN → fallbacks
        fonctionnels
      </p>
      <button class="btn-test" onclick="testOurSystem()">
        Tester Notre Système
      </button>
      <button class="btn-clear" onclick="clearConsole()">
        Nettoyer Console
      </button>
      <div id="our-results" class="log">
        Appuyez sur "Tester Notre Système" pour commencer...
      </div>
    </div>

    <!-- SECTION 2: Simulation approche ChatGPT -->
    <div class="test-section">
      <h2>💡 Approche ChatGPT (Simulée)</h2>
      <p><strong>Architecture:</strong> Assets locaux + stubs basiques</p>
      <button class="btn-test" onclick="testChatGPTApproach()">
        Tester Approche ChatGPT
      </button>
      <div id="chatgpt-results" class="log">
        Appuyez sur "Tester Approche ChatGPT" pour commencer...
      </div>
    </div>

    <!-- SECTION 3: Comparaison des erreurs console -->
    <div class="test-section">
      <h2>🔍 Monitoring des Erreurs Console</h2>
      <div id="error-monitor" class="log">
        Surveillance active des erreurs...
      </div>
    </div>

    <!-- Configuration des URLs d'assets (comme dans theme.liquid) -->
    <script>
      window.assetUrls = {
        bootstrap: "/assets/vendor-bootstrap.bundle.min.js",
        splide: "/assets/vendor-splide.min.js",
        glightbox: "/assets/vendor-glightbox.min.js",
        general: "/assets/general.js",
        search: "/assets/search.js",
        sections: "/assets/sections.js",
        collection: "/assets/collection.js",
        product: "/assets/product.js",
        cart: "/assets/cart.js",
        custom: "/assets/custom.js",
        stories: "/assets/stories-tooltips.js",
      };
      window.wishlistEnabled = true;
    </script>

    <!-- Notre système -->
    <script src="/assets/asset-fallbacks.js"></script>
    <script src="/assets/hybrid-script-loader.js"></script>

    <script>
      let errorCount = 0;
      let ourSystemResults = [];
      let chatgptResults = [];

      // Monitoring des erreurs
      const originalError = console.error;
      const originalWarn = console.warn;

      console.error = function (...args) {
        errorCount++;
        document.getElementById(
          "error-monitor"
        ).innerHTML += `<div style="color: red;">❌ ERROR: ${args.join(
          " "
        )}</div>`;
        return originalError.apply(console, args);
      };

      console.warn = function (...args) {
        document.getElementById(
          "error-monitor"
        ).innerHTML += `<div style="color: orange;">⚠️ WARNING: ${args.join(
          " "
        )}</div>`;
        return originalWarn.apply(console, args);
      };

      function clearConsole() {
        document.getElementById("our-results").innerHTML =
          "Console nettoyée...";
        document.getElementById("chatgpt-results").innerHTML = "";
        document.getElementById("error-monitor").innerHTML =
          "Surveillance redémarrée...";
        errorCount = 0;
      }

      async function testOurSystem() {
        const results = document.getElementById("our-results");
        results.innerHTML =
          '<div style="color: blue;">🔄 Test de notre système hybride en cours...</div>';

        const startTime = performance.now();
        let successCount = 0;
        let fallbackCount = 0;

        // Test des vérifications de notre système
        const tests = [
          {
            name: "Bootstrap",
            check: () => typeof window.bootstrap !== "undefined",
          },
          { name: "Splide", check: () => typeof window.Splide !== "undefined" },
          {
            name: "GLightbox",
            check: () => typeof window.GLightbox !== "undefined",
          },
        ];

        results.innerHTML += "<div>📋 Résultats des tests:</div>";

        for (const test of tests) {
          if (test.check()) {
            successCount++;
            results.innerHTML += `<div style="color: green;">✅ ${test.name}: Chargé avec succès</div>`;
          } else {
            fallbackCount++;
            results.innerHTML += `<div style="color: orange;">🔄 ${test.name}: Fallback activé</div>`;
          }
        }

        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);

        results.innerHTML += `
                <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 4px;">
                    <strong>📊 Résultats Notre Système:</strong><br>
                    ✅ Succès: ${successCount}/3<br>
                    🔄 Fallbacks: ${fallbackCount}/3<br>
                    ⏱️ Temps: ${totalTime}ms<br>
                    🚫 Erreurs console: ${errorCount}<br>
                    🎯 Taux de succès: ${Math.round(
                      ((successCount + fallbackCount) / 3) * 100
                    )}%
                </div>
            `;
      }

      async function testChatGPTApproach() {
        const results = document.getElementById("chatgpt-results");
        results.innerHTML =
          '<div style="color: blue;">🔄 Simulation de l\'approche ChatGPT...</div>';

        const startTime = performance.now();
        let successCount = 0;
        let errorCount = 0;

        // Simulation de l'approche ChatGPT (assets locaux + stubs)
        const chatgptTests = [
          {
            name: "Bootstrap",
            test: () =>
              simulateAssetLoad("/assets/vendor-bootstrap.bundle.min.js"),
          },
          {
            name: "Splide",
            test: () => simulateAssetLoad("/assets/vendor-splide.min.js"),
          },
          {
            name: "GLightbox",
            test: () => simulateAssetLoad("/assets/vendor-glightbox.min.js"),
          },
          {
            name: "General",
            test: () => simulateAssetLoad("/assets/general.js"),
          },
          {
            name: "Search",
            test: () => simulateAssetLoad("/assets/search.js"),
          },
        ];

        results.innerHTML += "<div>📋 Test des chargements (simulation):</div>";

        for (const test of chatgptTests) {
          try {
            const success = await test.test();
            if (success) {
              successCount++;
              results.innerHTML += `<div style="color: green;">✅ ${test.name}: Asset trouvé</div>`;
            } else {
              errorCount++;
              results.innerHTML += `<div style="color: red;">❌ ${test.name}: 404 ou erreur MIME</div>`;
            }
          } catch (error) {
            errorCount++;
            results.innerHTML += `<div style="color: red;">❌ ${test.name}: Erreur - ${error.message}</div>`;
          }
        }

        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);

        results.innerHTML += `
                <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 4px;">
                    <strong>📊 Résultats Approche ChatGPT:</strong><br>
                    ✅ Succès: ${successCount}/5<br>
                    ❌ Échecs: ${errorCount}/5<br>
                    ⏱️ Temps: ${totalTime}ms<br>
                    🎯 Taux de succès: ${Math.round(
                      (successCount / 5) * 100
                    )}%<br>
                    ⚠️ Note: Erreurs MIME toujours visibles dans console
                </div>
            `;
      }

      // Simulation de chargement d'asset (pour test ChatGPT)
      function simulateAssetLoad(url) {
        return new Promise((resolve) => {
          const script = document.createElement("script");
          script.src = url;
          script.onload = () => resolve(true);
          script.onerror = () => resolve(false);
          document.head.appendChild(script);

          // Nettoyer après test
          setTimeout(() => {
            if (script.parentNode) {
              script.parentNode.removeChild(script);
            }
          }, 100);
        });
      }

      // Auto-test au chargement
      window.addEventListener("load", () => {
        setTimeout(() => {
          document.getElementById("our-results").innerHTML +=
            '<div style="color: #666;">🔍 Système automatiquement initialisé</div>';
        }, 1000);
      });
    </script>
  </body>
</html>
