{%- comment -%}
Initialise Sentry côté navigateur, optionnel via paramètres de thème.
{%- endcomment -%}
{%- if settings.sentry_enable and settings.sentry_dsn != blank -%}
  {%- assign sentry_release = settings.sentry_release -%}
  {%- unless sentry_release and sentry_release != '' -%}
    {%- assign sentry_release = shop.permanent_domain | append: ':' | append: theme.id -%}
  {%- endunless -%}
  {%- assign sentry_env = settings.sentry_environment | default: 'production' -%}
  {%- assign traces_rate = settings.sentry_traces_sample_rate | default: 0 -%}
    {%- comment -%}
      Charger le SDK via le loader EU js-de.sentry-cdn.com/{PUBLIC_KEY}.min.js
      On extrait la clé publique à partir du DSN paramétré.
    {%- endcomment -%}
    {%- assign __dsn = settings.sentry_dsn | to_s -%}
    {%- assign __parts = __dsn | split: '//' -%}
    {%- assign __after_scheme = __parts | last -%}
    {%- assign __key_and_rest = __after_scheme | split: '@' -%}
    {%- assign __public_key = __key_and_rest | first -%}
    {%- if __public_key and __public_key != '' -%}
    {%- comment -%} theme-check-disable RemoteAsset ScriptTag {%- endcomment -%}
    <script src="https://js-de.sentry-cdn.com/{{ __public_key }}.min.js" crossorigin="anonymous" defer></script>
    {%- comment -%} theme-check-enable RemoteAsset ScriptTag {%- endcomment -%}
    {%- else -%}
    {%- comment -%} theme-check-disable RemoteAsset ScriptTag {%- endcomment -%}
    <script src="https://js-de.sentry-cdn.com/loader.min.js" crossorigin="anonymous" defer></script>
    {%- comment -%} theme-check-enable RemoteAsset ScriptTag {%- endcomment -%}
    {%- endif -%}
  <script>
    (function start(){
      try {
        if (!window.Sentry) return;
        Sentry.init({
          dsn: {{ settings.sentry_dsn | json }},
          integrations: [new Sentry.BrowserTracing()],
          tracesSampleRate: Number({{ traces_rate | json }}) || 0,
          environment: {{ sentry_env | json }},
          release: {{ sentry_release | json }},
          ignoreErrors: [
            'ResizeObserver loop limit exceeded',
            'Non-Error promise rejection captured',
            'NetworkError when attempting to fetch resource'
          ]
        });
        Sentry.setTags({ shop: {{ shop.permanent_domain | json }}, theme_id: {{ theme.id | json }} });
        if (new URLSearchParams(location.search).get('sentry_test') === '1') {
          Sentry.captureMessage('sentry-setup-ok');
        }
      } catch (e) {}
    })();
  </script>
{%- endif -%}
