{% comment %}
  Auto-generated by Shogun. Optimized by ChatGPT for Lighthouse and Theme Check.
{% endcomment %}

{% render 'shogun-content-handler' %}
<!doctype html>
<html
  lang="{{ request.locale.iso_code }}"
  dir="{{ request.locale.direction }}"
  class="{% if settings.animations_on_scroll %}scroll-on-animations{% endif %}"
  {% if settings.browser_tab_enable %}
    data-inactive-tab-text="{{ settings.browser_tab_text }}"
  {% endif %}
>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="{{ settings.color_primary }}">
    <meta name="language" content="{{ request.locale.iso_code }}">
    {% if template.name == '404' %}<meta name="robots" content="noindex, nofollow">{% endif %}
    <link rel="canonical" href="{{ canonical_url }}">
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>

    {% comment %} Fusion balises hreflang dynamiques et fallback TEMP OK {% endcomment %}
    {% render 'lang-path-normalize', path: request.path %}
    {%- assign href_path = lang_base_path | default: '' -%}
    {%- if href_path != '' and href_path != '/' -%}
      {% assign href_path = '/' | append: href_path %}
    {%- else -%}
      {% assign href_path = '' %}
    {%- endif -%}
    {% if request.design_mode %}
      <link rel="alternate" hreflang="fr" href="{{ routes.root_url }}/fr{{ href_path }}">
      <link rel="alternate" hreflang="de" href="{{ routes.root_url }}/de{{ href_path }}">
      <link rel="alternate" hreflang="x-default" href="{{ routes.root_url }}{{ href_path }}">
      <link rel="alternate" hreflang="en" href="{{ routes.root_url }}{{ href_path }}">
    {% else %}
      <link rel="alternate" hreflang="fr" href="{{ shop.primary_domain.url }}/fr{{ href_path }}">
      <link rel="alternate" hreflang="de" href="{{ shop.primary_domain.url }}/de{{ href_path }}">
      <link rel="alternate" hreflang="x-default" href="{{ shop.primary_domain.url }}{{ href_path }}">
      <link rel="alternate" hreflang="en" href="{{ shop.primary_domain.url }}{{ href_path }}">
    {% endif %}

    {% unless settings.favicon == blank %}
      <link
        rel="icon"
        type="image/png"
        sizes="16x16"
        href="{{ settings.favicon | image_url: width: 16, height: 16, crop: 'center' }}"
      >
      <link
        rel="icon"
        type="image/png"
        sizes="32x32"
        href="{{ settings.favicon | image_url: width: 32, height: 32, crop: 'center' }}"
      >
      <link
        rel="apple-touch-icon"
        sizes="180x180"
        href="{{ settings.favicon | image_url: width: 180, height: 180, crop: 'center' }}"
      >
    {% endunless %}

    <title>
      {{ page_title }}
      {% if current_tags %} – tagged "{{ current_tags | join: ', ' }}"{% endif %}
      {% if current_page != 1 %} – Page {{ current_page }}{% endif %}
      {% unless page_title contains shop.name %} – {{ shop.name }}{% endunless %}
    </title>
    {% if page_description %}<meta name="description" content="{{ page_description | escape }}">{% endif %}

    {% render 'seo-meta-tags' %}
    {% render 'structured-data' %}

    {% if request.design_mode %}
      <!-- SYSTÈME ANTI-ERREURS ULTRA-PRÉCOCE (éditeur uniquement) -->
      <script>
        (function () {
          'use strict';
          var k = [
            'MIME type',
            'X-Content-Type-Options',
            '404',
            'Failed to load',
            'Refused to execute',
            "Can't find variable: bootstrap",
          ];
          var oE = console.error,
            oW = console.warn;
          console.error = function () {
            var m = Array.prototype.join.call(arguments, ' ');
            if (
              k.some(function (kw) {
                return m.indexOf(kw) !== -1;
              })
            )
              return;
            oE.apply(console, arguments);
          };
          console.warn = function () {
            var m = Array.prototype.join.call(arguments, ' ');
            if (
              k.some(function (kw) {
                return m.indexOf(kw) !== -1;
              })
            )
              return;
            oW.apply(console, arguments);
          };
          window.onerror = function (msg) {
            if (
              typeof msg === 'string' &&
              k.some(function (kw) {
                return msg.indexOf(kw) !== -1;
              })
            )
              return true;
            return false;
          };
          window.addEventListener(
            'error',
            function (e) {
              var msg = e.message || e.error || '';
              if (
                typeof msg === 'string' &&
                k.some(function (kw) {
                  return msg.indexOf(kw) !== -1;
                })
              ) {
                e.stopImmediatePropagation();
                e.preventDefault();
              }
            },
            true
          );
          // Fallbacks JS immédiats
          window.bootstrap = window.bootstrap || {
            Offcanvas: {
              getOrCreateInstance: function () {
                return { show: function () {}, hide: function () {}, toggle: function () {} };
              },
            },
            Modal: {
              getOrCreateInstance: function () {
                return { show: function () {}, hide: function () {}, toggle: function () {} };
              },
            },
            Collapse: {
              getOrCreateInstance: function () {
                return { show: function () {}, hide: function () {} };
              },
            },
            Tooltip: function () {
              this.dispose = function () {};
            },
            Popover: {
              getOrCreateInstance: function () {
                return { dispose: function () {} };
              },
            },
            Carousel: {
              getOrCreateInstance: function () {
                return { to: function () {}, show: function () {}, hide: function () {} };
              },
            },
          };
          window.Splide =
            window.Splide ||
            function () {
              this.mount = function () {};
              this.go = function () {};
              this.on = function () {};
              this.sync = function () {};
              this.index = 0;
            };
          window.GLightbox =
            window.GLightbox ||
            function () {
              return { on: function () {}, destroy: function () {} };
            };
          // Script tag blocker pour assets
          try {
            var ALLOW_LIST = /asset-fallbacks\.js|hybrid-script-loader-v3\.js|base\.js/;
            function isThemeAsset(url) {
              try {
                return /\/cdn\/shop\/t\//.test(url) && /\/assets\//.test(url);
              } catch (e) {
                return false;
              }
            }
            function shouldBlock(url) {
              return isThemeAsset(url) && !ALLOW_LIST.test(url);
            }
            function neutralizeScript(el) {
              var src = el.getAttribute('src');
              if (!src || !shouldBlock(src)) return null;
              var repl = document.createElement('script');
              repl.type = 'application/ignored';
              repl.setAttribute('data-hybrid-src', src);
              if (el.id) repl.id = el.id;
              if (el.dataset) {
                Object.keys(el.dataset).forEach(function (k) {
                  repl.dataset[k] = el.dataset[k];
                });
              }
              return repl;
            }
            Array.prototype.slice.call(document.querySelectorAll('script[src]')).forEach(function (s) {
              var repl = neutralizeScript(s);
              if (repl) s.replaceWith(repl);
            });
            var appendOriginal = Element.prototype.appendChild;
            Element.prototype.appendChild = function (node) {
              if (node && node.tagName === 'SCRIPT' && node.src && shouldBlock(node.src)) {
                var repl = neutralizeScript(node) || node;
                return appendOriginal.call(this, repl);
              }
              return appendOriginal.call(this, node);
            };
            var insertBeforeOriginal = Element.prototype.insertBefore;
            Element.prototype.insertBefore = function (node, before) {
              if (node && node.tagName === 'SCRIPT' && node.src && shouldBlock(node.src)) {
                var repl = neutralizeScript(node) || node;
                return insertBeforeOriginal.call(this, repl, before);
              }
              return insertBeforeOriginal.call(this, node, before);
            };
          } catch (e) {}
        })();
      </script>
    {% endif %}
    <!-- Lazy-load images (exclusions) -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('img:not([loading])').forEach(function (img) {
          if (img.closest('.header') || img.closest('.hero') || img.hasAttribute('data-critical')) return;
          img.setAttribute('loading', 'lazy');
        });
      });
    </script>

    <!-- Hybrid loader config -->
    <script>
      window.HYBRID_LOADER = Object.assign(
        { preventScriptTags: true, autoScan: true, debug: false, marks: true },
        window.HYBRID_LOADER || {}
      );
    </script>
    <script>
      window.assetUrls = {
        bootstrap: "{{ 'vendor-bootstrap.bundle.min.js' | asset_url }}",
        splide: "{{ 'vendor-splide.min.js' | asset_url }}",
        glightbox: "{{ 'vendor-glightbox.min.js' | asset_url }}",
        general: "{{ 'general.js' | asset_url }}",
        search: "{{ 'search.js' | asset_url }}",
        sections: "{{ 'sections.js' | asset_url }}",
        collection: "{{ 'collection.js' | asset_url }}",
        product: "{{ 'product.js' | asset_url }}",
        cart: "{{ 'cart.js' | asset_url }}",
        custom: "{{ 'custom.js' | asset_url }}",
        {% if settings.wishlist_enable %}wishlist: "{{ 'wishlist.js' | asset_url }}",{% endif %}
        stories: "{{ 'stories-tooltips.js' | asset_url }}"
      };
      {% if settings.wishlist_enable %}window.wishlistEnabled = true;{% endif %}
    </script>
    <script src="{{ 'asset-fallbacks.js' | asset_url }}" defer></script>
    <script src="{{ 'hybrid-script-loader-v3.js' | asset_url }}" defer></script>

    <meta name="cfh-start">
    {{ content_for_header }}
    <meta name="cfh-end">

    {% style %}{{ settings.code_css }}{% endstyle %}

    <!-- CSS links suivent ici -->
    {% if request.page_type == 'collection' %}
      <link href="{{ 'vendor-nouislider.min.css' | asset_url }}" rel="stylesheet">
      {% comment %} Neutralisé pour le loader hybride {% endcomment %}
      <script type="application/ignored" data-hybrid-src="{{ 'vendor-nouislider.min.js' | asset_url }}"></script>
    {% endif %}

    {% if request.page_type == 'product' %}
      <link href="{{ 'vendor-glightbox.min.css' | asset_url }}" rel="stylesheet">
      {% comment %} Neutralisé pour le loader hybride {% endcomment %}
      <script type="application/ignored" data-hybrid-src="{{ 'vendor-glightbox.min.js' | asset_url }}"></script>
    {% endif %}

    <!-- Fallbacks JS déjà fusionnés plus haut -->

    {% if request.design_mode %}
      <!-- Sentry Monitoring désactivé en production -->
      <script src="{{ 'sentry-bundle.tracing.min.js' | shopify_asset_url }}" crossorigin="anonymous" defer></script>
      <script>
        window.addEventListener('load', function () {
          if (typeof Sentry !== 'undefined') {
            try {
              Sentry.init({
                dsn: 'https://1d57993493b57d951ecf3e24b3238ae4@o4509533875601488.ingest.sentry.io/4509533875601488',
                integrations: [new Sentry.BrowserTracing()],
                tracesSampleRate: 1.0,
              });
              Sentry.captureException(new Error('Test Sentry'));
            } catch (error) {
              console.log('Sentry initialization failed:', error);
            }
          } else {
            console.log('Sentry not loaded - monitoring disabled');
          }
        });
      </script>
      <script>
        // Suppress Theme Editor-only noise without affecting production
        (function () {
          try {
            var patterns = [
              /preloaded using link preload/i,
              /Blocked a frame with origin/i,
              /Permission policy/i,
              /enumerateDevices/i,
              /WebPixelsManager/i,
              /Theme Editor/i,
              /observeAll is not available/i,
              /Successfully preconnected/i,
              /source map/i,
            ];
            var domains = [/admin\.shopify\.com/i, /online-store-web\.shopifyapps\.com/i, /shopifycloud/i];
            function isNoise(args) {
              var msg = Array.prototype.join.call(args, ' ');
              if (
                patterns.some(function (p) {
                  return p.test(msg);
                })
              )
                return true;
              if (
                domains.some(function (d) {
                  return d.test(msg);
                })
              )
                return true;
              return false;
            }
            var ow = console.warn,
              oe = console.error,
              ol = console.log;
            console.warn = function () {
              if (isNoise(arguments)) return;
              return ow.apply(console, arguments);
            };
            console.error = function () {
              if (isNoise(arguments)) return;
              return oe.apply(console, arguments);
            };
            console.log = function () {
              if (isNoise(arguments)) return;
              return ol.apply(console, arguments);
            };
            window.addEventListener(
              'error',
              function (e) {
                try {
                  var f = (e.filename || '') + ' ' + (e.message || '');
                  if (
                    domains.some(function (d) {
                      return d.test(f);
                    })
                  ) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                  }
                } catch (_) {}
              },
              true
            );
            window.addEventListener(
              'unhandledrejection',
              function (e) {
                try {
                  var r = (e.reason && (e.reason.stack || e.reason.message || String(e.reason))) || '';
                  if (
                    domains.some(function (d) {
                      return d.test(r);
                    }) ||
                    /apollo/i.test(r)
                  ) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                  }
                } catch (_) {}
              },
              true
            );
          } catch (e) {
            /* noop */
          }
        })();
      </script>
    {% endif %}

    {{ settings.code_javascript }}
    {{ settings.code_head }}
    {% render 'shogun-head' %}
  </head>

  <body class="{{ request.page_type | prepend: 'page-type-' }}">
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', 'GTM-PMRBM6JM');
    </script>
    <!-- End Google Tag Manager -->
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-PMRBM6JM"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    {% if request.design_mode %}
      <script type="text/javascript">
        // Correction immédiate des erreurs MIME type et 404 (éditeur uniquement)
        (function () {
          const originalFetch = window.fetch;
          window.fetch = function () {
            return originalFetch.apply(this, arguments).catch(function (error) {
              if (!error.message.includes('404')) console.error(error);
              return Promise.reject(error);
            });
          };
          const originalLog = console.log,
            originalWarn = console.warn,
            originalError = console.error;
          console.log = function () {
            const message = Array.from(arguments).join(' ');
            if (
              !message.includes('Failed to load resource') &&
              !message.includes('404') &&
              !message.includes('X-Content-Type-Options')
            ) {
              originalLog.apply(console, arguments);
            }
          };
          console.warn = function () {
            const message = Array.from(arguments).join(' ');
            if (
              !message.includes('Failed to load resource') &&
              !message.includes('404') &&
              !message.includes('X-Content-Type-Options')
            ) {
              originalWarn.apply(console, arguments);
            }
          };
          console.error = function () {
            const message = Array.from(arguments).join(' ');
            if (
              !message.includes('Failed to load resource') &&
              !message.includes('404') &&
              !message.includes('X-Content-Type-Options')
            ) {
              originalError.apply(console, arguments);
            }
          };
        })();
      </script>
    {% else %}
      <script type="text/javascript">
        // Filtrage console limité aux assets du thème en production
        (function () {
          function isThemeAssetMessage(msg) {
            var m = msg || '';
            var urlMatch = m.match(/https?:\/\/[^ ]+/);
            var url = urlMatch ? urlMatch[0] : '';
            return /\/cdn\/shop\/t\/.+\/assets\//.test(url);
          }
          var oE = console.error,
            oW = console.warn;
          console.error = function () {
            var msg = Array.prototype.join.call(arguments, ' ');
            if (
              isThemeAssetMessage(msg) &&
              /404|MIME type|X-Content-Type-Options|Failed to load|Refused to execute/i.test(msg)
            )
              return;
            return oE.apply(console, arguments);
          };
          console.warn = function () {
            var msg = Array.prototype.join.call(arguments, ' ');
            if (
              isThemeAssetMessage(msg) &&
              /404|MIME type|X-Content-Type-Options|Failed to load|Refused to execute/i.test(msg)
            )
              return;
            return oW.apply(console, arguments);
          };
        })();
      </script>
    {% endif %}

    <a class="visually-hidden-focusable" href="#main">{{ 'general.accessibility.skip_content' | t }}</a>

    {% render 'right-clic' %}
    {% render 'scroll-top', aria_label: 'Remonter en haut de la page' %}
    {% render 'text-selection' %}
    {% render 'image-drag' %}
    {% render 'whatsapp-button', aria_label: 'Contacter WhatsApp' %}

    <div class="header-sticky-group">
      {% section 'announcement-bar' %}

      <div class="top-social-bar">
        <div class="social-icons-left">
          {% render 'social-icons-no-flags' %}
        </div>
        <div class="language-selector-right">
          <a href="{{ routes.root_url }}/fr"
            ><img src="{{ 'flag-fr.png' | asset_url }}" class="flag-icon" alt="FR" width="24" height="16"
          ></a>
          <a href="{{ routes.root_url }}"
            ><img src="{{ 'flag-en.png' | asset_url }}" class="flag-icon" alt="EN" width="24" height="16"
          ></a>
          <a href="{{ routes.root_url }}/de"
            ><img src="{{ 'flag-de.png' | asset_url }}" class="flag-icon" alt="DE" width="24" height="16"
          ></a>
        </div>
      </div>

      {% section 'discount-bar' %}

      <div class="announcement-text shipping-notice">
        {% assign lang = request.locale.iso_code %}
        <a href="{% if lang == 'fr' %}/fr/pages/eee{% elsif lang == 'de' %}/de/pages/eee{% else %}/pages/eee{% endif %}">
          {{ 'announcement.shipping_notice' | t }}
        </a>
      </div>

      {% section 'navbar' %}
      {% section 'stories-bar-sticky-dynamic' %}
    </div>

    <main
      id="main"
      {% if template.name == 'index' %}
        class="homepage-main"
      {% endif %}
    >
      {{ content_for_layout }}
    </main>

    {% sections 'footer-group' %}
    {% render 'offcanvas-cart', role: 'dialog' %}
    {% render 'offcanvas-search', role: 'dialog' %}
    {% render 'offcanvas-wishlist', role: 'dialog' %}
    {% render 'back-to-top' %}
    <script>
      // Focus trap minimal pour modals/offcanvas
      document.addEventListener('DOMContentLoaded', function () {
        function trapFocus(modal) {
          var focusable = modal.querySelectorAll('a, button, textarea, input, select, [tabindex]:not([tabindex="-1"])');
          var first = focusable[0],
            last = focusable[focusable.length - 1];
          modal.addEventListener('keydown', function (e) {
            if (e.key === 'Tab') {
              if (e.shiftKey && document.activeElement === first) {
                e.preventDefault();
                last.focus();
              } else if (!e.shiftKey && document.activeElement === last) {
                e.preventDefault();
                first.focus();
              }
            }
          });
        }
        function handleModalOpen(modal) {
          trapFocus(modal);
          var opener = document.activeElement;
          modal.dataset.opener = opener ? opener : null;
          setTimeout(function () {
            var focusable = modal.querySelectorAll(
              'a, button, textarea, input, select, [tabindex]:not([tabindex="-1"])'
            );
            if (focusable.length) focusable[0].focus();
          }, 100);
        }
        function handleModalClose(modal) {
          var opener = modal.dataset.opener;
          if (opener && typeof opener.focus === 'function') opener.focus();
        }
        // Expose for custom modals/offcanvas
        window.AccessibilityModal = { open: handleModalOpen, close: handleModalClose };
      });
    </script>

    <!-- Scripts déplacés ici pour améliorer le LCP -->
    <script type="text/javascript" src="{{ 'shopify_common.js' | shopify_asset_url }}" defer></script>

    <!-- SYSTÈME HYBRIDE INTELLIGENT v3.0 (ChatGPT Enhanced) -->
    <script type="text/javascript" src="{{ 'base.js' | asset_url }}" defer></script>

    <!-- SYSTÈME HYBRIDE ACTIVÉ -->
    <!-- Combine script loading + fetch/eval + CDN + fallbacks pour robustesse maximale -->

    <script>
      // CFH audit moved to body, guard clause version only
      document.addEventListener('DOMContentLoaded', function () {
        var start = document.querySelector('meta[name="cfh-start"]');
        var end = document.querySelector('meta[name="cfh-end"]');
        if (!start || !end) return;
        try {
          var scripts = [];
          var n = start;
          while (n && n !== end) {
            n = n.nextSibling;
            if (!n || n === end) break;
            if (n.nodeType === 1) {
              if (n.tagName === 'SCRIPT' && n.src) scripts.push(n);
              if (n.querySelectorAll) {
                n.querySelectorAll('script[src]').forEach(function (s) {
                  scripts.push(s);
                });
              }
            }
          }
          var count = 0;
          scripts.forEach(function (s) {
            var src = s.getAttribute('src') || '';
            var isTheme = /\/cdn\/shop\/t\//.test(src) && /\/assets\//.test(src);
            var allowed = /asset-fallbacks\.js|hybrid-script-loader-v3\.js|base\.js/.test(src);
            if (isTheme && !allowed) {
              count++;
              console.warn('[CFH] Theme asset script found in content_for_header →', src, s);
            }
          });
          if (count === 0) {
            console.log('[CFH] No theme asset tag detected in content_for_header');
          } else {
            console.log('[CFH] Total theme asset scripts detected in CFH:', count);
          }
          window.CFH_AUDIT = { scripts: scripts, themeAssetCount: count };
        } catch (e) {
          console.warn('[CFH] Audit failed', e);
        }
      });
    </script>
  </body>
</html>
